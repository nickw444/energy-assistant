server:
  host: 127.0.0.1
  port: 8000
  data_dir: ./data

homeassistant:
  base_url: "http://example.invalid"
  token: "fixture-token"
  verify_tls: true

ems:
  timestep_minutes: 5
  min_horizon_minutes: 720 # 12 hours minimum; solver uses the shortest forecast length.

plant:
  grid:
    max_import_kw: 13.0
    max_export_kw: 13.0
    realtime_grid_power:
      type: home_assistant
      entity: sensor.hass_energy_grid_power_smoothed_1m
    
    realtime_price_import:
      type: home_assistant
      entity: sensor.amber_general_price
    realtime_price_export:
      type: home_assistant
      entity: sensor.amber_feed_in_price

    price_import_forecast:
      type: home_assistant
      platform: amberelectric
      entity: sensor.amber_general_forecast
      use_advanced_price_forecast: true
    price_export_forecast:
      type: home_assistant
      platform: amberelectric
      entity: sensor.amber_feed_in_forecast
      use_advanced_price_forecast: true
    
    import_forbidden_periods:
      - start: "14:55"
        end: "21:05"

  load:
    # Note: Load power entity should exclude loads that are controlled by the 
    # EMS (e.g. EV chargers, smart appliances), listed below under "loads".
    realtime_load_power:
      type: home_assistant
      entity: sensor.hass_energy_load_power_smoothed_1m
    
    forecast:
      type: home_assistant
      platform: historical_average
      entity: sensor.hass_energy_load_power_smoothed_15m
      history_days: 3
      interval_duration: 5
      unit: W

  inverters:
    # DC coupled PV + Battery inverter example.
    - id: primary
      name: Primary
      peak_power_kw: 10.0
      curtailment: load-aware
      # curtailment: binary
      pv:
        realtime_power:
          type: home_assistant
          entity: sensor.hass_energy_pv_power_smoothed_1m

        forecast:
          type: home_assistant
          platform: solcast
          entities:
            - sensor.solcast_pv_forecast_forecast_today
            - sensor.solcast_pv_forecast_forecast_tomorrow
            - sensor.solcast_pv_forecast_forecast_day_3
          # type: solcast_api
          # In the future the user could provide parameters to allow us to request
          # forecasts from an external service. 
          # For now, users will retrieve forecasts from Home Assistant.
      battery:
        capacity_kwh: 41.9
        storage_efficiency_pct: 96.0 # Charge/discharge storage efficiency
        throughput_cost_per_kwh: 0.01 # Wear cost per kWh charged or discharged
        min_soc_pct: 10.0
        max_soc_pct: 100.0

        # Specify a level of reserve to ensure some energy is always left in the battery
        # for grid outages or other emergencies.
        reserve_soc_pct: 25.0

        # Optional, if different from inverter parameters. e.g. DC-coupled batteries could charge 
        # from PV at a higher rate than the inverter peak power.
        max_charge_kw: 10.5
        max_discharge_kw: 10.0

        state_of_charge_pct:
          type: home_assistant
          entity: sensor.inverter_battery_soc
        realtime_power:
          type: home_assistant
          entity: sensor.hass_energy_battery_power_smoothed_1m
    
    # AC coupled PV inverter example.
    # - name: Sungrow
    #   peak_power_kw: 5.0
    #   curtailment: binary
    #   pv:
    #     forecast:
    #       type: home_assistant
    #       platform: solcast
    #       entities:
    #         - sensor.solcast_pv_forecast_forecast_today
    #         - sensor.solcast_pv_forecast_forecast_tomorrow
    #         - sensor.solcast_pv_forecast_forecast_day_3

loads:
  - id: tessie
    name: "Tessie"
    load_type: "controlled_ev"
    min_power_kw: 0.0
    max_power_kw: 7.4
    energy_kwh: 78.0
    connected:
      type: home_assistant
      entity: binary_sensor.tesla_wall_connector_vehicle_connected
    realtime_power:
      type: home_assistant
      entity: sensor.tessie_charger_power
    state_of_charge_pct:
      type: home_assistant
      entity: sensor.tessie_battery
    
    
    soc_incentives:
      - target_soc_pct: 40.0
        incentive: 0.08
      - target_soc_pct: 60.0
        incentive: 0.06
      - target_soc_pct: 80.0
        incentive: 0.04
      - target_soc_pct: 90.0
        incentive: 0.00 # << No monetary incentive to charge to 90%, but should satisfy self-use goals.
    # Note: should implement a penalty for switching on/off too frequently - prefer long sessions.
    # Note: should implement a way for user to specify desired departure time to ensure vehicle is charged 
    #       to specified SoC by then in the most optimal/cost effective way.

  # - name: "HWS"
  #   load_type: "nonvariable_load"
