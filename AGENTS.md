## Ways of working
- Use uv for dependency management and scripts. Keep tooling config in `pyproject.toml` and `pyrightconfig.json`.
- Default to built-in exceptions unless a distinct custom type is justified.
- Keep backend and worker logic modular; API is FastAPI, worker runs background planning tasks (scheduled every minute) and is wired from `cli` with explicit dependencies. Worker code lives in `hass_energy/worker/` so it can grow into multiple modules. Avoid tight coupling so the future frontend can live alongside the backend at the repo root.
- Reactive replanning: `Worker` internally subscribes to price entity state changes via Home Assistant WebSocket API and triggers replanning with a short debounce (0.75s) to coalesce simultaneous import/export price updates. The 1-minute schedule remains as a safety net.
- `HomeAssistantWebSocketClient` (`hass_energy/lib/home_assistant_ws.py`) provides async WebSocket subscriptions for entity state changes with automatic reconnection and exponential backoff.
- Persist config and runtime artifacts to the filesystem (`data_dir` from YAML config). The single YAML file (default `config.yaml`) stores server + Home Assistant + plant + energy settings; it is read once at startup and the API is read-only for config (no writes). Avoid destructive commands that would drop user data.
- Shared helpers (e.g., Home Assistant client) live under `hass_energy/lib/` to keep worker/API code lean.
- CLI accepts a YAML config (`--config`, default `config.yaml`) for static settings like host, port, and data_dir. Config is validated with Pydantic. Worker is always on; host/port flags were removed.
- Systemd units should use an absolute path to `uv` in `ExecStart` when `uv` is installed under a user-local path (e.g., `/root/.local/bin/uv`), because systemd only searches a limited set of system paths.
- For self-contained tasks when requested, create a git worktree under `.worktrees/<meaningful-name>`, copy `config.dev.yaml` into the worktree root, and run `uv sync` there before starting work.
- GitHub uses squash merges; when cleaning up worktrees, rely on PR merged status or deleted remote branches rather than `git branch --merged`.
- When updating PR descriptions via `gh`, prefer `gh pr edit --body-file <path>` to preserve markdown formatting.
- Routes are split by domain under `hass_energy/api/routes/` (e.g., `plan`, `settings`). Settings endpoint surfaces runtime energy settings (read-only; user edits YAML).
- MILP logic lives under `hass_energy/worker/milp/` using PuLP; planner/compiler are placeholders awaiting real constraints.
- MILP v2 scaffolding lives under `src/hass_energy/milp_v2/` with a compile phase (config + `ValueResolver` -> `CompiledModel`) and an execute phase (solve -> `PlanResult`).
- CLI `hass-energy milp` now wires the MILP v2 planner (compiler + executor); it currently fails until those phases are implemented.
- Keep local lint commands aligned with CI; ruff checks `src`, `custom_components`, and `tests`.
- Keep type checking aligned with CI; pyright runs against `src`, `custom_components`, and `tests`.
- MILP v2 slotting uses `EmsConfig.timestep_minutes` with a horizon length derived from the shortest forecast, bounded by `EmsConfig.min_horizon_minutes`, to align forecast slots to the current block start.
- Plotting helpers live in `src/hass_energy/plotting/` and are shared by CLI.
- A lightweight plan checker lives at `hass_energy/worker/milp/checker.py` with pytest coverage in `tests/`.
- `hass_energy/worker/milp/ha_dump.py` now emits a single-battery stub in realtime inputs when `battery_soc` is available (capacity/limits are currently constants).
- `hass_energy/worker/milp/ha_dump.py` emits a simple EV stub when `ev_connected` is true (defaults for capacity, target SOC, max power, value-per-kWh, min power, and switch penalty).
- Tests should mirror the `src/hass_energy` package structure under `tests/` (e.g., `tests/hass_energy/ems/`).
- EMS fixture snapshots use summarized `tests/fixtures/ems/**/ems_plan.json` baselines (single source of truth). Refresh with `hass-energy ems refresh-baseline --name <scenario>` and use `--force-image` when the plan hash is unchanged but you still need to regenerate plot images (e.g., plotting-only tweaks).
- Planner now consumes a resolved payload (no source models). Resolved schemas live in `src/hass_energy/models/resolved.py`; resolution scaffolding/registry is under `src/hass_energy/lib/resolution/` for two-pass fetch→transform in the future.
- This is unreleased software; schema changes can be breaking without backward-compatibility shims.
- When config schemas change in backward-incompatible ways, update any captured scenario configs under `tests/fixtures/ems/**/ems_config.yaml` to keep fixture tests passing.
- EMS-specific guidance lives in `src/hass_energy/ems/AGENTS.md`.
- EMS plan `EconomicsTimestepPlan` costs are grid import/export only and exclude other objective terms (EV incentives, penalties, curtailment tie-breaks, violation penalties, battery wear).
- EMS objective favors self-consumption via `self_consumption_bias_pct` (adds premium to import, discounts export). Battery wear cost (`charge_cost_per_kwh`, `discharge_cost_per_kwh`) allows separate cost per kWh for charge and discharge.
- `EmsPlanOutput` now includes `objective_value` with the solver objective (may be negative/None).
- Load-aware curtailment is forced on whenever export price is negative, enabling PV to follow load and blocking export for those slots.
- EMS horizons can use `EmsConfig.timestep_minutes` plus `high_res_timestep_minutes` / `high_res_horizon_minutes` to run a higher-resolution window before switching to the default timestep; boundaries snap to the next interval boundary for aligned coarse slots and alignment uses time-weighted averages for variable slot sizes.
- Amber price forecasts from Home Assistant may include 1-second offsets at interval boundaries; alignment should tolerate small (≈2s) gaps so hourly slots still align.
- Historical-average load forecasts can repeat daily averages beyond 24h via `forecast_horizon_hours` (default 24).
- `ConfigMapper` (`src/hass_energy/lib/resolver/__init__.py`) offers a recursive walk utility that calls a visitor for side effects and allows halting recursion by returning `False`.
- Home Assistant integration (POC) lives under `custom_components/hass_energy`.
- Home Assistant integration guidance lives in `custom_components/hass_energy/AGENTS.md`.
- Home Assistant integration uses `custom_components/hass_energy/hass_energy_client/` for the lightweight aiohttp + Pydantic API client aligned with the FastAPI OpenAPI responses.
- Home Assistant integration shares a single API client and data update coordinator via `entry.runtime_data`, and prefers typed model access over dynamic path traversal where possible.
- Any FastAPI contract changes must be reflected in `custom_components/hass_energy/hass_energy_client/`, and the Home Assistant custom integration should be refactored as needed to keep it in sync.

## Continuous learning
- When you learn new project knowledge, coding style, or preferences during a session, update `AGENTS.md` (and `README.md` if it affects users) before finishing so the next agent benefits.
